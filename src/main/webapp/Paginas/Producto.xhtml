<?xml version="1.0" encoding="UTF-8"?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:ues="http://xmlns.jcp.org/jsf/composite/ues"
                template="../WEB-INF/templates/default.xhtml">

   <!-- Header -->
   <ui:define name="header">
      <h1 class="titulo-formulario">#{crud['frm.botones.producto']}</h1>
   </ui:define>

   <!-- Tabla de registros -->
   <ui:define name="contenido-tabla">
      <h:panelGroup id="pnlProductoTabla">
         <h:form id="frmProductoTop">
            <p:dataTable id="tblProductos"
                         value="#{productoFrm.modelo}"
                         var="r"
                         paginator="true"
                         paginatorPosition="bottom"
                         lazy="true"
                         selection="#{productoFrm.registro}"
                         selectionMode="single"
                         rowKey="#{r.id}"
                         rows="#{productoFrm.registrosPorPagina}"
                         rendered="#{productoFrm.estado=='NADA'}">

               <p:column headerText="ID">
                  <h:outputText value="#{r.id}" />
               </p:column>

               <p:column headerText="#{crud['frm.botones.nombre']}">
                  <h:outputText value="#{r.nombreProducto}" />
               </p:column>

               <p:column headerText="#{crud['frm.botones.referencia']}">
                  <h:outputText value="#{r.referenciaExterna}" />
               </p:column>

               <p:column headerText="#{crud['frm.botones.comentarios']}">
                  <h:outputText value="#{r.comentarios}" />
               </p:column>

               <p:column headerText="#{crud['frm.botones.activo']}">
                  <h:outputText value="#{r.activo ? 'ACTIVO' : 'INACTIVO'}" />
               </p:column>

               <p:ajax event="rowSelect"
                       listener="#{productoFrm.seleccionarRegistro}"
                       update=":pnlProductoTabla :pnlProductoDetalle"/>
            </p:dataTable>

            <ues:botones-top formulario="#{productoFrm}"
                             actualizar=":pnlProductoTabla :pnlProductoDetalle"/>
         </h:form>
      </h:panelGroup>
   </ui:define>

   <!-- Detalle -->
   <ui:define name="contenido-detalle">
      <h:panelGroup id="pnlProductoDetalle">
         <p:tabView id="tabProducto" cache="false" dynamic="true"
                    rendered="#{productoFrm.estado!='NADA'}">

            <p:tab id="tabGeneral" closable="false" title="#{crud['frm.botones.generalidades']}">
               <h:form id="frmProductoCrear">
                  <h:panelGrid columns="2">
                     <p:outputLabel for="txtProductoId" value="ID:"/>
                     <p:inputText id="txtProductoId" value="#{productoFrm.registro.id}"
                                  readonly="true" disabled="true" size="75"/>
                     <p:outputLabel for="txtProductoNombre" value="#{crud['frm.botones.nombreProducto']}:"/>
                     <p:inputText id="txtProductoNombre" value="#{productoFrm.registro.nombreProducto}"
                                  required="true" size="75"/>
                     <p:outputLabel for="txtProductoReferencia" value="#{crud['frm.botones.referenciaExterna']}:"/>
                     <p:inputText id="txtProductoReferencia" value="#{productoFrm.registro.referenciaExterna}"
                                  size="50"/>
                     <p:outputLabel for="txtProductoComentarios" value="#{crud['frm.botones.comentarios']}:"/>
                     <p:inputTextarea id="txtProductoComentarios" value="#{productoFrm.registro.comentarios}"
                                      rows="4" cols="50"/>
                     <p:outputLabel for="chkProductoActivo" value="#{crud['frm.botones.activo']}:"/>
                     <p:selectBooleanCheckbox id="chkProductoActivo" value="#{productoFrm.registro.activo}"/>
                  </h:panelGrid>

                  <h:panelGrid columns="#{productoFrm.estado=='MODIFICAR' ? 1 : 2}">
                     <p:commandButton value="#{crud['frm.botones.guardar']}"
                                      actionListener="#{productoFrm.btnGuardarHandler}"
                                      rendered="#{productoFrm.estado=='CREAR'}"
                                      update=":pnlProductoTabla :pnlProductoDetalle"
                                      process="@form"/>
                     <p:commandButton value="#{crud['frm.botones.modificar']}"
                                      actionListener="#{productoFrm.btnModificarHandler}"
                                      rendered="#{productoFrm.estado=='MODIFICAR'}"
                                      update=":pnlProductoTabla :pnlProductoDetalle"
                                      process="@form"/>
                     <p:commandButton value="#{crud['frm.botones.eliminar']}"
                                      actionListener="#{productoFrm.btnEliminarHandler}"
                                      rendered="#{productoFrm.estado=='MODIFICAR'}"
                                      update=":pnlProductoTabla :pnlProductoDetalle"
                                      process="@form"/>
                  </h:panelGrid>
               </h:form>
            </p:tab>

            <!-- Pestaña de Tipos de Producto -->
            <p:tab id="tabTiposProducto" closable="false" title="#{crud['frm.botones.tiposDeProductos']}"
                   disabled="#{productoFrm.estado!='MODIFICAR'}">

               <!-- Panel de Tabla -->
               <h:panelGroup id="pnlTipoProductoTabla">
                  <h:form id="frmTablaTipoProducto">
                     <p:dataTable id="tblTiposProducto"
                                  value="#{productoFrm.ptpFrm.modelo}"
                                  var="tp"
                                  paginator="true"
                                  paginatorPosition="bottom"
                                  lazy="true"
                                  selection="#{productoFrm.ptpFrm.registro}"
                                  selectionMode="single"
                                  rowKey="#{tp.id}"
                                  rows="#{productoFrm.ptpFrm.registrosPorPagina}"
                                  rendered="#{productoFrm.ptpFrm.estado=='NADA'}">

                        <p:column headerText="ID">
                           <h:outputText value="#{tp.id}" />
                        </p:column>
                        <p:column headerText="#{crud['frm.botones.tipos']}">
                           <h:outputText value="#{tp.idTipoProducto.nombre}" />
                        </p:column>
                        <p:column headerText="#{crud['frm.botones.fechaCreacion']}">
                           <h:outputText value="#{tp.fechaCreacion}">
                              <f:converter converterId="offsetDateTimeConverter" />
                           </h:outputText>
                        </p:column>
                        <p:column headerText="#{crud['frm.botones.estado']}">
                           <h:outputText value="#{tp.activo ? 'ACTIVO' : 'INACTIVO'}" />
                        </p:column>
                        <p:column headerText="#{crud['frm.botones.observaciones']}">
                           <h:outputText value="#{tp.observaciones}" />
                        </p:column>

                        <p:ajax event="rowSelect"
                                listener="#{productoFrm.ptpFrm.seleccionarRegistro}"
                                update=":tabProducto:pnlTipoProductoTabla :tabProducto:pnlTipoProductoDetalle"/>
                     </p:dataTable>

                     <ues:botones-top formulario="#{productoFrm.ptpFrm}"
                                      actualizar=":tabProducto:pnlTipoProductoTabla :tabProducto:pnlTipoProductoDetalle"/>
                  </h:form>
               </h:panelGroup>

               <!-- Panel de Detalle -->
               <h:panelGroup id="pnlTipoProductoDetalle">
                  <h:form id="frmDetalleTipoProducto" rendered="#{productoFrm.ptpFrm.estado!='NADA'}">

                     <h:panelGrid columns="1" style="margin-bottom: 20px;">

                        <!-- ID -->
                        <p:outputLabel for="txtIdTp" value="ID:"/>
                        <p:inputText id="txtIdTp" value="#{productoFrm.ptpFrm.registro.id}"
                                     readonly="true" disabled="true" size="75"/>

                        <!-- Tipo de Producto -->
                        <p:outputLabel for="txtNombre" value="#{crud['frm.botones.tiposDeProductos']}:"/>
                        <h:panelGroup id="pnlTipoProducto">
                           <h:panelGrid columns="2" style="width: 100%;">
                              <p:inputText id="txtNombre" value="#{productoFrm.ptpFrm.registro.idTipoProducto.nombre}"
                                           size="75" readonly="true" disabled="true"/>
                              <p:commandButton type="button"
                                               icon="pi pi-external-link"
                                               onclick="PF('dlgTipoProducto').show();"
                                               value="#{crud['frm.botones.seleccionarTipo']}"
                                               rendered="#{productoFrm.ptpFrm.estado=='CREAR' or productoFrm.ptpFrm.estado=='MODIFICAR'}"/>
                           </h:panelGrid>

                           <h:panelGroup id="pnlCaracteristicas"
                                         rendered="#{not empty productoFrm.ptpFrm.registro.idTipoProducto}"
                                         style="margin-top: 15px;">
                              <p:outputLabel value="#{crud['frm.botones.caracteristica']}" style="font-weight: bold; display: block; margin-bottom: 8px;"/>
                              <h:panelGrid columns="3" style="width: 100%;">
                                 <h:panelGrid>
                                    <p:outputLabel for="listDisponibles" value="Características Disponibles" />
                                    <h:selectOneListbox id="listDisponibles"
                                                        style="width: 300px; height: 150px;"
                                                        value="#{productoFrm.ptpFrm.caracteristicaSeleccionadaDisponible}">
                                       <f:selectItems value="#{productoFrm.ptpFrm.posibleCaracteristicas}"
                                                      var="pc"
                                                      itemLabel="#{pc.idCaracteristica.nombre}"
                                                      itemValue="#{pc}"/>
                                       <f:converter converterId="TipoProductoCaracteristicaConverter" />
                                    </h:selectOneListbox>
                                 </h:panelGrid>

                                 <h:panelGrid style="vertical-align: middle; padding-left: 20px;">
                                    <p:commandButton value="#{crud['frm.botones.agregar']} →"
                                                     style="margin-bottom: 5px;"
                                                     icon="pi pi-plus"
                                                     actionListener="#{productoFrm.ptpFrm.agregarCaracteristica}"
                                                     update="pnlCaracteristicas btnGuardarTp btnModificarTp btnRemoverTp"
                                                     process="listDisponibles @this"/>
                                    <p:commandButton value="← #{crud['frm.botones.remover']}"
                                                     style="margin-bottom: 5px;"
                                                     icon="pi pi-minus"
                                                     actionListener="#{productoFrm.ptpFrm.eliminarCaracteristica}"
                                                     update="pnlCaracteristicas btnGuardarTp btnModificarTp"
                                                     process="listSeleccionadas @this"
                                                     disabled="#{not empty productoFrm.ptpFrm.caracteristicaSeleccionadaSeleccionada and productoFrm.ptpFrm.esCaracteristicaObligatoria(productoFrm.ptpFrm.caracteristicaSeleccionadaSeleccionada)}"
                                                     id="btnRemoverTp"/>
                                 </h:panelGrid>

                                 <h:panelGrid>
                                    <p:outputLabel for="listSeleccionadas" value="#{crud['frm.botones.caracteristicaSeleccionada']}"/>
                                    <h:selectOneListbox id="listSeleccionadas"
                                                        style="width: 300px; height: 150px"
                                                        value="#{productoFrm.ptpFrm.caracteristicaSeleccionadaSeleccionada}">
                                       <f:selectItems value="#{productoFrm.ptpFrm.caracteristicasSeleccionadas}"
                                                      var="cs"
                                                      itemLabel="#{productoFrm.ptpFrm.obtenerEtiquetaCaracteristica(cs)}"
                                                      itemValue="#{cs}"/>
                                       <f:converter converterId="TipoProductoCaracteristicaConverter" />
                                       <p:ajax event="change"
                                               listener="#{productoFrm.ptpFrm.onCaracteristicaSeleccionadaChange}"
                                               update="seccionValorCaracteristica txtValorCaracteristica btnRemoverTp"
                                               process="@this"/>
                                    </h:selectOneListbox>

                                    <!-- SECCIÓN DE VALOR -->
                                    <h:panelGroup id="seccionValorCaracteristica">
                                       <!-- Mostrar formulario de valor solo cuando hay característica seleccionada -->

                                          <h:panelGrid columns="1" style="width: 100%; margin-top: 15px; padding: 15px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px;">
                                             <p:outputLabel for="txtValorCaracteristica"
                                                            value="Valor para: #{productoFrm.ptpFrm.caracteristicaSeleccionadaSeleccionada.idCaracteristica.nombre}"
                                                            style="font-weight: bold; color: #495057; display: block; margin-bottom: 10px;"/>

                                             <h:panelGrid columns="2" style="width: 100%; column-gap: 10px;">
                                                <p:inputNumber id="txtValorCaracteristica"
                                                               value="#{productoFrm.ptpFrm.valorCaracteristica}"
                                                               placeholder="Ingrese valor numérico"
                                                               decimalPlaces="2"
                                                               minValue="0"
                                                               maxValue="999999.99"
                                                               style="width: 200px;"/>

                                                <p:commandButton value="Guardar Valor"
                                                                 icon="pi pi-save"
                                                                 style="background-color: #28a745; border-color: #28a745;"
                                                                 actionListener="#{productoFrm.ptpFrm.guardarValorCaracteristica}"
                                                                 update="@form"
                                                                 process="@this txtValorCaracteristica"/>
                                             </h:panelGrid>
                                          </h:panelGrid>


                                       <!-- Mensaje cuando no hay característica seleccionada -->
                                       <h:panelGroup rendered="#{productoFrm.ptpFrm.caracteristicaSeleccionadaSeleccionada == null}">
                                          <p:outputLabel value="Seleccione una característica para asignar un valor"
                                                         style="color: #6c757d; font-style: italic; display: block; margin-top: 15px; padding: 15px; text-align: center;"/>
                                       </h:panelGroup>
                                    </h:panelGroup>
                                 </h:panelGrid>
                              </h:panelGrid>

                              <!-- SECCIÓN: Mostrar valores para todas las características -->
                              <h:panelGroup id="pnlValoresActuales"
                                            rendered="#{not empty productoFrm.ptpFrm.caracteristicasSeleccionadas}"
                                            style="margin-top: 20px; padding: 15px; border-radius: 5px;">
                                 <p:outputLabel value="Valores Actuales:" style="font-weight: bold; display: block; margin-bottom: 10px; color: #495057;"/>

                                 <h:panelGrid columns="2" style="width: 100%;" columnClasses="label,value">
                                    <ui:repeat value="#{productoFrm.ptpFrm.caracteristicasSeleccionadas}" var="caracteristica">
                                       <p:outputLabel value="#{caracteristica.idCaracteristica.nombre}:"
                                                      style="font-weight: normal; padding: 5px 0;"/>
                                       <h:panelGroup style="padding: 5px 0;">
                                          <p:outputLabel value="#{productoFrm.ptpFrm.valoresCaracteristicas[caracteristica.id] != null ? productoFrm.ptpFrm.valoresCaracteristicas[caracteristica.id] : ' Sin valor'}"
                                                         style="#{productoFrm.ptpFrm.valoresCaracteristicas[caracteristica.id] != null ? 'color: #28a745; font-weight: bold; padding: 0 8px; margin: 0 4px;' : 'color: #dc3545; font-style: italic; padding: 0 8px; margin: 0 4px;'}"/>
                                       </h:panelGroup>
                                    </ui:repeat>
                                 </h:panelGrid>


                                 <!-- VALIDACION: Mostrar advertencia si hay caracteristicas sin valor -->
                                 <h:panelGroup rendered="#{productoFrm.ptpFrm.hayCaracteristicasSinValor}">
                                    <p:outputLabel value="Advertencia: Hay caracteristicas sin valor asignado. Debe asignar valores a todas las caracteristicas antes de guardar."
                                                   style="color: #856404; font-weight: bold; display: block; margin-top: 10px;"/>
                                 </h:panelGroup>
                              </h:panelGroup>

                              <!-- Información de estado -->
                              <p:outputLabel value="#{crud['frm.botones.totalSeleccionadas']}: #{productoFrm.ptpFrm.caracteristicasSeleccionadas.size()}"
                                             style="display: block; margin-top: 10px; font-style: italic; color: #666;"/>
                           </h:panelGroup>
                        </h:panelGroup>

                        <!-- Activo -->
                        <p:outputLabel for="chkActivoTp" value="#{crud['frm.botones.activo']}:"/>
                        <p:selectBooleanCheckbox id="chkActivoTp"
                                                 value="#{productoFrm.ptpFrm.registro.activo}"/>

                        <!-- Fecha de Creación -->
                        <p:outputLabel for="dpFechaCreacion" value="#{crud['frm.botones.fechaCreacion']}:"/>
                        <p:datePicker id="dpFechaCreacion"
                                      value="#{productoFrm.ptpFrm.registro.fechaCreacion}"
                                      showTime="true"
                                      hourFormat="24"
                                      timeInput="true"
                                      timeZone="America/El_Salvador"
                                      pattern="yyyy-MM-dd'T'HH:mm"
                                      converter="offsetDateTimeConverter"
                                      required="true"
                                      requiredMessage="#{crud['frm.botones.laFechaEsObligatoria']}"
                                      touchUI="false"
                                      readonly="#{productoFrm.ptpFrm.estado=='MODIFICAR'}"/>

                        <!-- Observaciones -->
                        <p:outputLabel for="txtObservacionesTp" value="#{crud['frm.botones.observaciones']}:"/>
                        <p:inputTextarea id="txtObservacionesTp"
                                         value="#{productoFrm.ptpFrm.registro.observaciones}"
                                         rows="4" cols="50"/>

                     </h:panelGrid>

                     <!-- BOTONES DE ACCIÓN CON VALIDACIÓN -->
                     <h:panelGrid columns="3" style="margin-top: 20px;">
                        <p:commandButton value="#{crud['frm.botones.guardar']}"
                                         actionListener="#{productoFrm.ptpFrm.btnGuardarHandler}"
                                         rendered="#{productoFrm.ptpFrm.estado=='CREAR'}"
                                         update=":tabProducto:pnlTipoProductoTabla :tabProducto:pnlTipoProductoDetalle"
                                         process="@form"
                                         disabled="#{productoFrm.ptpFrm.hayCaracteristicasSinValor}"
                                         id="btnGuardarTp"/>

                        <p:commandButton value="#{crud['frm.botones.modificar']}"
                                         actionListener="#{productoFrm.ptpFrm.btnModificarHandler}"
                                         rendered="#{productoFrm.ptpFrm.estado=='MODIFICAR'}"
                                         update=":tabProducto:pnlTipoProductoTabla :tabProducto:pnlTipoProductoDetalle"
                                         process="@form"
                                         disabled="#{productoFrm.ptpFrm.hayCaracteristicasSinValor}"
                                         id="btnModificarTp"/>

                        <p:commandButton value="#{crud['frm.botones.eliminar']}"
                                         actionListener="#{productoFrm.ptpFrm.btnEliminarHandler}"
                                         rendered="#{productoFrm.ptpFrm.estado=='MODIFICAR'}"
                                         update=":tabProducto:pnlTipoProductoTabla :tabProducto:pnlTipoProductoDetalle"
                                         process="@form"
                                         id="btnEliminarTp"/>
                     </h:panelGrid>

                     <!-- MENSAJE DE VALIDACION -->
                     <h:panelGroup rendered="#{productoFrm.ptpFrm.hayCaracteristicasSinValor}"
                                   style="margin-top: 15px;">
                        <p:outputLabel value="No se puede guardar. Todas las caracteristicas deben tener un valor asignado."
                                       style="color: #721c24; font-weight: bold; display: block;"/>
                     </h:panelGroup>
                  </h:form>
               </h:panelGroup>
            </p:tab>
         </p:tabView>
      </h:panelGroup>
   </ui:define>

   <!-- Diálogo -->
   <ui:define name="extras">
      <p:dialog id="dlgTipoProducto" widgetVar="dlgTipoProducto" modal="true"
                closable="true" header="#{crud['frm.botones.seleccionarTipoProducto']}"
                resizable="false" width="500" height="auto">
         <h:form id="frmDlgTipoProducto">
            <h:panelGrid columns="1" style="width: 100%;">
               <h:panelGrid columns="2" style="width: 100%; margin-bottom: 15px;">
                  <h:outputLabel value="#{crud['frm.botones.tiposDeProductos']}:" for="txtTipoProducto"
                                 style="font-weight: bold;"/>
                  <p:autoComplete id="txtTipoProducto"
                                  completeMethod="#{productoFrm.ptpFrm.buscarTiposPorNombres}"
                                  value="#{productoFrm.ptpFrm.registro.idTipoProducto}"
                                  var="tp"
                                  converter="TipoProductoConverter"
                                  itemLabel="#{tp.nombre} (#{tp.id})"
                                  itemValue="#{tp}"
                                  forceSelection="true"
                                  dropdown="true"
                                  size="20"
                                  required="true"
                                  requiredMessage="#{crud['frm.botones.debeSeleccionarUnTipoDeProducto']}"/>
               </h:panelGrid>

               <h:panelGrid columns="1" style="text-align: center; margin-top: 15px;">
                  <p:commandButton value="#{crud['frm.botones.seleccionar']}"
                                   actionListener="#{productoFrm.ptpFrm.btnSeleccionarTipoProductoHandler}"
                                   process="@form"
                                   update=":tabProducto:frmDetalleTipoProducto:pnlTipoProducto :tabProducto:frmDetalleTipoProducto:pnlCaracteristicas"
                                   oncomplete="PF('dlgTipoProducto').hide();"/>
               </h:panelGrid>
            </h:panelGrid>
         </h:form>
      </p:dialog>

      <!-- Diálogo de carga -->
      <p:dialog widgetVar="statusDialog" modal="true" draggable="false" closable="false" resizable="false"
                showHeader="false" style="background: transparent; border: none; box-shadow: none;">
         <h:form>
            <h:panelGrid columns="1" style="text-align: center;">
               <p:graphicImage name="images/loading.gif" />
               <h:outputText value="Procesando..." style="color: white; font-size: 14px;"/>
            </h:panelGrid>
         </h:form>
      </p:dialog>
   </ui:define>
</ui:composition>