<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="jakarta.faces.html"
                xmlns:f="jakarta.faces.core"
                xmlns:p="http://primefaces.org/ui"
                xmlns:ui="jakarta.faces.facelets"
                template="../WEB-INF/templates/default.xhtml">

   <!-- Header -->
   <ui:define name="header">
      <h1 class="titulo-formulario">#{despachoBodegaFrm.nombreBean}</h1>
   </ui:define>

   <!-- Tabla de registros -->
   <ui:define name="contenido-tabla">
      <h:panelGroup id="pnlDespachoBodegaTabla">
         <h:form id="frmDespachoBodegaTop">
            <p:dataTable id="tblVentasAprobadas"
                         value="#{despachoBodegaFrm.modelo}"
                         var="venta"
                         paginator="true"
                         paginatorPosition="bottom"
                         lazy="true"
                         selection="#{despachoBodegaFrm.registro}"
                         selectionMode="single"
                         rowKey="#{venta.id}"
                         rows="#{despachoBodegaFrm.registrosPorPagina}"
                         widgetVar="wvVentasAprobadas"
                         rendered="#{despachoBodegaFrm.estado=='NADA'}">

               <!-- ID Venta -->
               <p:column headerText="ID" width="250">
                  <h:outputText value="#{venta.id}" />
               </p:column>

               <!-- Cliente -->
               <p:column headerText="Cliente" width="200">
                  <h:outputText value="#{venta.idCliente.nombre}" />
               </p:column>

               <!-- Estado -->
               <p:column headerText="Estado" width="120">
                  <h:outputText value="#{venta.estado}" 
                                style="font-weight: bold; color: #27ae60;"/>
               </p:column>

               <!-- Total -->
               <p:column headerText="Total" width="120">
                  <h:outputText value="#{venta.total}">
                     <f:convertNumber type="currency" currencySymbol="$" minFractionDigits="2" maxFractionDigits="2"/>
                  </h:outputText>
               </p:column>

               <!-- Fecha de Venta -->
               <p:column headerText="Fecha Venta" width="150">
                  <h:outputText value="#{venta.fecha}">
                     <f:converter converterId="offsetDateTimeConverter" />
                  </h:outputText>
               </p:column>

               <!-- Observaciones -->
               <p:column headerText="Observaciones" width="200">
                  <h:outputText value="#{venta.observaciones}" />
               </p:column>

               <p:ajax event="rowSelect"
                       listener="#{despachoBodegaFrm.seleccionarRegistro}"
                       update=":pnlDespachoBodegaTabla :pnlDespachoBodegaDetalle :tabDespachoBodega"/>
            </p:dataTable>

            <!-- Remote Command para actualización automática vía WebSocket -->
            <p:remoteCommand name="refrescarTablaVentas"
                             actionListener="#{despachoBodegaFrm.actualizarTablaAutomaticamente}"
                             update=":pnlTabla:growlGlobal tblVentasAprobadas"
                             process="@none"
                             global="false"
                             async="true"/>

         </h:form>
      </h:panelGroup>
   </ui:define>

   <!-- Detalle (Formulario con pestañas) -->
   <ui:define name="contenido-detalle">
      <h:panelGroup id="pnlDespachoBodegaDetalle">
         <p:tabView id="tabDespachoBodega" cache="false" dynamic="true"
                    rendered="#{despachoBodegaFrm.estado!='NADA'}">

            <!-- Pestaña Información de Venta -->
            <p:tab id="tabInfo" closable="false" title="Información de Venta">
               <h:form id="frmDespachoBodegaInfo">
                  <h:panelGrid columns="2" style="width: 100%;">

                     <!-- ID (Solo lectura) -->
                     <p:outputLabel for="txtVentaId" value="ID Venta:"/>
                     <p:inputText id="txtVentaId" value="#{despachoBodegaFrm.registro.id}"
                                  readonly="true" disabled="true" size="35"/>

                     <!-- Cliente (Solo lectura) -->
                     <p:outputLabel for="txtCliente" value="Cliente:"/>
                     <p:inputText id="txtCliente" value="#{despachoBodegaFrm.registro.idCliente.nombre}"
                                  readonly="true" disabled="true" size="50"/>

                     <!-- Estado (Solo lectura) -->
                     <p:outputLabel for="txtEstado" value="Estado:"/>
                     <p:inputText id="txtEstado" value="#{despachoBodegaFrm.registro.estado}"
                                  readonly="true" disabled="true" 
                                  style="font-weight: bold; color: #27ae60;"/>

                     <!-- Fecha (Solo lectura) -->
                     <p:outputLabel for="dpFecha" value="Fecha Venta:"/>
                     <p:datePicker id="dpFecha"
                                   value="#{despachoBodegaFrm.fechaVenta}"
                                   showTime="true"
                                   hourFormat="24"
                                   timeZone="America/El_Salvador"
                                   pattern="yyyy-MM-dd'T'HH:mm"
                                   readonly="true"
                                   disabled="true"/>

                     <!-- Total (Solo lectura) -->
                     <p:outputLabel for="txtTotal" value="Total Venta:"/>
                     <p:inputText id="txtTotal" value="#{despachoBodegaFrm.totalVenta}"
                                  readonly="true" disabled="true"
                                  style="font-weight: bold; font-size: 14px;">
                        <f:convertNumber type="currency" currencySymbol="$" minFractionDigits="2" maxFractionDigits="2"/>
                     </p:inputText>

                     <!-- Observaciones (Solo lectura) -->
                     <p:outputLabel for="txtObservaciones" value="Observaciones:"/>
                     <p:inputTextarea id="txtObservaciones"
                                      value="#{despachoBodegaFrm.registro.observaciones}"
                                      rows="4" cols="50"
                                      readonly="true" disabled="true"/>

                  </h:panelGrid>

                  <!-- Botones de acción -->
                  <h:panelGrid columns="2" style="margin-top: 20px;">
                     <p:commandButton value="Marcar como ENTREGADO"
                                      actionListener="#{despachoBodegaFrm.marcarComoEntregado}"
                                      update=":pnlTabla :pnlDespachoBodegaTabla :pnlDespachoBodegaDetalle"
                                      icon="pi pi-check"
                                      styleClass="ui-button-success"
                                      style="width: 220px; font-weight: bold;" />
                     
                     <p:commandButton value="#{crud['frm.botones.cancelar']}"
                                      actionListener="#{despachoBodegaFrm.btnCancelarHandler}"
                                      update=":pnlTabla :pnlDespachoBodegaTabla :pnlDespachoBodegaDetalle"
                                      icon="pi pi-times"
                                      styleClass="ui-button-secondary"
                                      style="width: 200px;"/>
                  </h:panelGrid>

               </h:form>
            </p:tab>

            <!-- Pestaña Productos (Detalles de Venta) - SOLO LECTURA -->
            <p:tab id="tabProductos" closable="false" title="Productos a Despachar">
               <h:panelGroup id="pnlDespachoBodegaDetalleTabla">
                  <h:form id="frmTablaDetalleDespacho">
                     <p:dataTable id="tblDetallesDespacho"
                                  value="#{despachoBodegaFrm.ventaDetalleFrm.modelo}"
                                  var="detalle"
                                  paginator="true"
                                  paginatorPosition="bottom"
                                  lazy="true"
                                  rowKey="#{detalle.id}"
                                  rows="#{despachoBodegaFrm.ventaDetalleFrm.registrosPorPagina}">

                        <!-- ID Detalle -->
                        <p:column headerText="ID" width="80">
                           <h:outputText value="#{detalle.id}" />
                        </p:column>

                        <!-- Producto -->
                        <p:column headerText="Producto" width="250">
                           <h:outputText value="#{detalle.idProducto.nombreProducto}" 
                                         style="font-weight: bold;"/>
                        </p:column>

                        <!-- Referencia -->
                        <p:column headerText="Referencia" width="120">
                           <h:outputText value="#{detalle.idProducto.referenciaExterna}" />
                        </p:column>

                        <!-- Cantidad -->
                        <p:column headerText="Cantidad" width="100">
                           <h:outputText value="#{detalle.cantidad}" 
                                         style="font-weight: bold; color: #2980b9;">
                              <f:convertNumber pattern="0.##" />
                           </h:outputText>
                        </p:column>

                        <!-- Almacén Origen (Dropdown) -->
                        <p:column headerText="Almacén Origen" width="250">
                           <p:selectOneMenu 
                              value="#{despachoBodegaFrm.almacenSeleccionadoPorDetalle[detalle.id]}"
                              disabled="#{despachoBodegaFrm.registro.estado == 'ENTREGADO'}"
                              style="width: 100%;">
                              <f:selectItem itemLabel="-- Seleccione Almacén --" itemValue="#{null}" noSelectionOption="true"/>
                              <f:selectItems 
                                 value="#{despachoBodegaFrm.obtenerAlmacenesConStock(detalle)}"
                                 var="almacen"
                                 itemValue="#{almacen[0]}"
                                 itemLabel="#{almacen[1]} (Stock: #{almacen[2]})"
                                 itemDisabled="#{almacen[2] lt detalle.cantidad}" />
                              <p:ajax update="@form" />
                           </p:selectOneMenu>
                           
                           <!-- Mensaje si no hay almacenes disponibles -->
                           <h:outputText 
                              value=" Sin almacenes disponibles" 
                              rendered="#{empty despachoBodegaFrm.obtenerAlmacenesConStock(detalle)}"
                              style="color: #e74c3c; font-weight: bold; font-size: 0.9em;" />
                        </p:column>

                        <!-- Stock Disponible -->
                        <p:column headerText="Stock Disponible" width="150">
                           <h:panelGroup>
                              <!-- Stock SUFICIENTE (verde) -->
                              <h:outputText 
                                 value="#{despachoBodegaFrm.obtenerStockDisponible(detalle.id)}"
                                 rendered="#{despachoBodegaFrm.obtenerStockDisponible(detalle.id) ge detalle.cantidad 
                                           and despachoBodegaFrm.almacenSeleccionadoPorDetalle[detalle.id] != null}"
                                 style="font-weight: bold; font-size: 1.1em; color: #27ae60;">
                                 <f:convertNumber pattern="0.##" />
                              </h:outputText>
                              
                              <!-- Stock INSUFICIENTE (rojo) -->
                              <h:outputText 
                                 value="#{despachoBodegaFrm.obtenerStockDisponible(detalle.id)}"
                                 rendered="#{despachoBodegaFrm.obtenerStockDisponible(detalle.id) lt detalle.cantidad 
                                           and despachoBodegaFrm.almacenSeleccionadoPorDetalle[detalle.id] != null}"
                                 style="font-weight: bold; font-size: 1.1em; color: #e74c3c;">
                                 <f:convertNumber pattern="0.##" />
                              </h:outputText>
                              
                              <!-- Icono de advertencia si stock insuficiente -->
                              <h:outputText 
                                 value="  INSUFICIENTE" 
                                 rendered="#{despachoBodegaFrm.obtenerStockDisponible(detalle.id) lt detalle.cantidad 
                                           and despachoBodegaFrm.almacenSeleccionadoPorDetalle[detalle.id] != null}"
                                 style="color: #e74c3c; font-weight: bold; font-size: 0.85em; margin-left: 5px;" />
                              
                              <!-- Mensaje si no hay almacén seleccionado -->
                              <h:outputText 
                                 value="-- Seleccione almacén --" 
                                 rendered="#{despachoBodegaFrm.almacenSeleccionadoPorDetalle[detalle.id] == null}"
                                 style="color: #95a5a6; font-style: italic; font-size: 0.9em;" />
                           </h:panelGroup>
                        </p:column>

                        <!-- Precio Unitario -->
                        <p:column headerText="Precio Unitario" width="120">
                           <h:outputText value="#{detalle.precio}">
                              <f:convertNumber type="currency" currencySymbol="$" />
                           </h:outputText>
                        </p:column>

                        <!-- Subtotal -->
                        <p:column headerText="Subtotal" width="120">
                           <h:outputText value="#{detalle.cantidad * detalle.precio}"
                                         style="font-weight: bold;">
                              <f:convertNumber type="currency" currencySymbol="$" />
                           </h:outputText>
                        </p:column>

                        <!-- Estado -->
                        <p:column headerText="Estado" width="100">
                           <h:outputText value="#{detalle.estado}" />
                        </p:column>

                        <!-- Observaciones -->
                        <p:column headerText="Observaciones" width="200">
                           <h:outputText value="#{detalle.observaciones}" />
                        </p:column>

                     </p:dataTable>

                  </h:form>
               </h:panelGroup>

            </p:tab>

         </p:tabView>
      </h:panelGroup>
   </ui:define>

   <!-- WebSocket JavaScript Puro para actualización automática en tiempo real -->
   <ui:define name="extras">
      <h:outputScript>
         //<![CDATA[
         let ws = null;
         let reconnectAttempts = 0;
         const MAX_RECONNECT_ATTEMPTS = 5;
         const RECONNECT_DELAY = 3000;
         
         function conectarWebSocket() {
             try {
                 const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                 const wsUrl = protocol + '//' + window.location.host + '#{request.contextPath}' + '/websocket/ventas';
                 
                 ws = new WebSocket(wsUrl);
                 
                 ws.onopen = function() {
                     reconnectAttempts = 0;
                 };
                 
                 ws.onmessage = function(event) {
                     console.log('Mensaje recibido en DespachoBodega:', event.data);
                     
                     if (event.data === 'refresh' && typeof refrescarTablaVentas !== 'undefined') {
                         // Actualizar tabla primero
                         refrescarTablaVentas();
                         
                         // Mostrar notificación usando PrimeFaces
                         try {
                             if (typeof PF === 'function' && PF('growlWidgetDespacho')) {
                                 PF('growlWidgetDespacho').show([{
                                     severity: 'info',
                                     summary: '¡Nueva Venta Aprobada!',
                                     detail: 'Se ha aprobado una venta. La tabla se actualizará automáticamente.'
                                 }]);
                             } else {
                                 console.warn('PrimeFaces growl no disponible en DespachoBodega');
                             }
                         } catch (e) {
                             console.error('Error al mostrar notificación:', e);
                         }
                     }
                 };
                 
                 ws.onclose = function() {
                     if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                         reconnectAttempts++;
                         setTimeout(conectarWebSocket, RECONNECT_DELAY);
                     }
                 };
                 
             } catch (error) {
                 console.error('Error WebSocket:', error);
             }
         }
         
         window.addEventListener('load', conectarWebSocket);
         
         window.addEventListener('beforeunload', function() {
             if (ws && ws.readyState === WebSocket.OPEN) {
                 ws.close();
             }
         });
         //]]>
      </h:outputScript>
   </ui:define>

</ui:composition>
