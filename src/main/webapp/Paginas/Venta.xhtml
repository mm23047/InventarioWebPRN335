<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="jakarta.faces.html"
                xmlns:f="jakarta.faces.core"
                xmlns:p="http://primefaces.org/ui"
                xmlns:ui="jakarta.faces.facelets"
                xmlns:ues="jakarta.faces.composite/ues"
                template="../WEB-INF/templates/default.xhtml">

   <!-- Header -->
   <ui:define name="header">
      <h1 class="titulo-formulario">#{ventaFrm.nombreBean}</h1>
   </ui:define>

   <!-- Tabla de registros -->
   <ui:define name="contenido-tabla">
      <h:panelGroup id="pnlVentaTabla">
         <h:form id="frmVentaTop">
            <p:dataTable id="tblVentas"
                         value="#{ventaFrm.modelo}"
                         var="venta"
                         paginator="true"
                         paginatorPosition="bottom"
                         lazy="true"
                         selection="#{ventaFrm.registro}"
                         selectionMode="single"
                         rowKey="#{venta.id}"
                         rows="#{ventaFrm.registrosPorPagina}"
                         rendered="#{ventaFrm.estado=='NADA'}">

               <!-- ID Venta -->
               <p:column headerText="ID" width="250">
                  <h:outputText value="#{venta.id}" />
               </p:column>

               <!-- Cliente -->
               <p:column headerText="Cliente" width="200">
                  <h:outputText value="#{venta.idCliente.nombre}" />
               </p:column>

               <!-- Estado -->
               <p:column headerText="Estado" width="120">
                  <h:outputText value="#{venta.estado}" />
               </p:column>

               <!-- Total -->
               <p:column headerText="Total" width="120">
                  <h:outputText value="#{venta.total}">
                     <f:convertNumber type="currency" currencySymbol="$" minFractionDigits="2" maxFractionDigits="2"/>
                  </h:outputText>
               </p:column>

               <!-- Fecha de Venta -->
               <p:column headerText="Fecha Venta" width="150">
                  <h:outputText value="#{venta.fecha}">
                     <f:converter converterId="offsetDateTimeConverter" />
                  </h:outputText>
               </p:column>

               <!-- Observaciones -->
               <p:column headerText="Observaciones" width="200">
                  <h:outputText value="#{venta.observaciones}" />
               </p:column>

               <p:ajax event="rowSelect"
                       listener="#{ventaFrm.seleccionarRegistro}"
                       update=":pnlVentaTabla :pnlVentaDetalle :tabVenta"/>
            </p:dataTable>

            <!-- Total General de Ventas -->
            <h:panelGroup style="display: block; text-align: right; margin-top: 20px; padding: 15px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px;">
               <h:outputText value="TOTAL GENERAL DE VENTAS: "
                             style="font-weight: bold; font-size: 16px; color: #2c3e50; margin-right: 10px;"/>
               <h:outputText value="#{ventaFrm.totalGeneralVentas}"
                             style="font-weight: bold; font-size: 18px; color: #27ae60;">
                  <f:convertNumber type="currency" currencySymbol="$" minFractionDigits="2" maxFractionDigits="2"/>
               </h:outputText>
            </h:panelGroup>

            <ues:botones-top formulario="#{ventaFrm}"
                             actualizar=":pnlVentaTabla :pnlVentaDetalle"/>
         </h:form>
      </h:panelGroup>
   </ui:define>

   <!-- Detalle (Formulario con pestañas) -->
   <ui:define name="contenido-detalle">
      <h:panelGroup id="pnlVentaDetalle">
         <p:tabView id="tabVenta" cache="false" dynamic="true"
                    rendered="#{ventaFrm.estado!='NADA'}">

            <!-- Pestaña Generalidades -->
            <p:tab id="tabGeneral" closable="false" title="Generalidades">
               <h:form id="frmVentaCrear">
                  <h:panelGrid columns="1">

                     <!-- ID (Auto-generado) -->
                     <p:outputLabel for="txtVentaId" value="ID:"/>
                     <p:inputText id="txtVentaId" value="#{ventaFrm.registro.id}"
                                  readonly="true" disabled="true" size="35"/>

                     <!-- Cliente (Relación con Clientes) -->
                     <h:panelGroup>
                        <p:outputLabel for="autoCliente" value="Cliente:"/>
                        <p:autoComplete id="autoCliente"
                                        value="#{ventaFrm.clienteSeleccionado}"
                                        completeMethod="#{ventaFrm.completarClientes}"
                                        var="cliente"
                                        itemLabel="#{cliente.nombre}"
                                        itemValue="#{cliente}"
                                        forceSelection="true"
                                        dropdown="true"
                                        required="true"
                                        requiredMessage="Seleccione un cliente"
                                        size="50"
                                        placeholder="Escriba el nombre...">
                           <f:converter converterId="clienteConverter" />
                           <p:ajax event="itemSelect"
                                   listener="#{ventaFrm.seleccionarCliente}"
                                   update="@form"/>
                        </p:autoComplete>
                        <p:message for="autoCliente" display="icon"/>
                     </h:panelGroup>

                     <!-- Estado (Dropdown con opciones) -->
                     <p:outputLabel for="selEstado" value="Estado:"/>
                     <p:selectOneMenu id="selEstado" value="#{ventaFrm.registro.estado}"
                                      required="true" requiredMessage="Seleccione un estado">
                        <f:selectItems value="#{ventaFrm.estadosVenta}"
                                       var="estado"
                                       itemLabel="#{estado}"
                                       itemValue="#{estado}"/>
                     </p:selectOneMenu>

                     <!-- Fecha (Automática) -->
                     <p:outputLabel for="dpFecha" value="Fecha Venta:"/>
                     <p:datePicker id="dpFecha"
                                   value="#{ventaFrm.fechaVenta}"
                                   showTime="true"
                                   hourFormat="24"
                                   timeInput="true"
                                   timeZone="America/El_Salvador"
                                   pattern="yyyy-MM-dd'T'HH:mm"
                                   readonly="true"
                                   disabled="true"/>

                     <!-- Observaciones -->
                     <p:outputLabel for="txtObservaciones" value="Observaciones:"/>
                     <p:inputTextarea id="txtObservaciones"
                                      value="#{ventaFrm.registro.observaciones}"
                                      rows="4" cols="50"/>

                  </h:panelGrid>

                  <!-- Botones de acción para Venta -->
                  <h:panelGrid columns="#{ventaFrm.estado=='MODIFICAR' ? 3 : 2}" style="margin-top: 20px;">
                     <p:commandButton value="#{crud['frm.botones.guardar']}"
                                      actionListener="#{ventaFrm.btnGuardarHandler}"
                                      rendered="#{ventaFrm.estado=='CREAR'}"
                                      update=":pnlVentaTabla :pnlVentaDetalle"
                                      process="@form"/>

                     <p:commandButton value="#{crud['frm.botones.modificar']}"
                                      actionListener="#{ventaFrm.btnModificarHandler}"
                                      rendered="#{ventaFrm.estado=='MODIFICAR'}"
                                      update=":pnlVentaTabla :pnlVentaDetalle"
                                      process="@form"/>

                     <p:commandButton value="#{crud['frm.botones.eliminar']}"
                                      actionListener="#{ventaFrm.btnEliminarHandler}"
                                      rendered="#{ventaFrm.estado=='MODIFICAR'}"
                                      update=":pnlVentaTabla :pnlVentaDetalle"
                                      process="@form"/>

                     <!-- Botón Cerrar venta -->
                     <p:commandButton value="Cerrar venta"
                                      actionListener="#{ventaFrm.notificarCambioKardex}"
                                      update=":pnlVentaDetalle :pnlVentaTabla"
                                      rendered="#{ventaFrm.estado=='MODIFICAR'}"
                                      process="@form"/>

                  </h:panelGrid>

               </h:form>
            </p:tab>

            <!-- Pestaña Productos (Detalles de Venta) -->
            <p:tab id="tabProductos" closable="false" title="Productos"
                   disabled="#{ventaFrm.estado!='MODIFICAR'}">
               <!-- Panel de Tabla de Detalles (Tabla 2) -->
               <h:panelGroup id="pnlVentaDetalleTabla">
                  <h:form id="frmTablaVentaDetalle">
                     <p:dataTable id="tblVentaDetalles"
                                  value="#{ventaFrm.ventaDetalleFrm.modelo}"
                                  var="detalle"
                                  paginator="true"
                                  paginatorPosition="bottom"
                                  lazy="true"
                                  selection="#{ventaFrm.ventaDetalleFrm.registro}"
                                  selectionMode="single"
                                  rowKey="#{detalle.id}"
                                  rows="#{ventaFrm.ventaDetalleFrm.registrosPorPagina}"
                                  rendered="#{ventaFrm.ventaDetalleFrm.estado=='NADA'}">

                        <!-- ID Detalle -->
                        <p:column headerText="ID" width="80">
                           <h:outputText value="#{detalle.id}" />
                        </p:column>

                        <!-- Producto -->
                        <p:column headerText="Producto" width="200">
                           <h:outputText value="#{detalle.idProducto.nombreProducto}" />
                        </p:column>

                        <!-- Cantidad -->
                        <p:column headerText="Cantidad" width="100">
                           <h:outputText value="#{detalle.cantidad}">
                              <f:convertNumber pattern="0" />
                           </h:outputText>
                        </p:column>

                        <!-- Precio Unitario -->
                        <p:column headerText="Precio Unitario" width="120">
                           <h:outputText value="#{detalle.precio}">
                              <f:convertNumber type="currency" currencySymbol="$" />
                           </h:outputText>
                        </p:column>

                        <!-- Estado -->
                        <p:column headerText="Estado" width="120">
                           <h:outputText value="#{detalle.estado}" />
                        </p:column>

                        <!-- Observaciones -->
                        <p:column headerText="Observaciones" width="200">
                           <h:outputText value="#{detalle.observaciones}" />
                        </p:column>

                        <p:ajax event="rowSelect"
                                listener="#{ventaFrm.ventaDetalleFrm.seleccionarRegistro}"
                                update=":tabVenta:pnlVentaDetalleTabla :tabVenta:pnlVentaDetalleFormulario"/>
                     </p:dataTable>

                     <!-- Botón Nuevo Detalle de Venta -->
                     <p:commandButton value="Nuevo Detalle de Venta"
                                      actionListener="#{ventaFrm.ventaDetalleFrm.btnNuevoHandler}"
                                      rendered="#{ventaFrm.ventaDetalleFrm.estado=='NADA'}"
                                      update=":tabVenta:pnlVentaDetalleTabla :tabVenta:pnlVentaDetalleFormulario"
                                      style="margin-top: 10px;"/>

                  </h:form>
               </h:panelGroup>

               <!-- Panel de Formulario de Detalle -->
               <h:panelGroup id="pnlVentaDetalleFormulario">
                  <h:form id="frmDetalleVenta" rendered="#{ventaFrm.ventaDetalleFrm.estado!='NADA'}">
                     <p:panel header="Detalle de Venta" style="margin-top: 20px;">

                        <h:panelGrid columns="1" style="width: 100%;">

                           <!-- ID Detalle (Auto-generado) -->
                           <p:outputLabel for="txtDetalleId" value="ID:"/>
                           <p:inputText id="txtDetalleId" value="#{ventaFrm.ventaDetalleFrm.registro.id}"
                                        readonly="true" disabled="true" size="35"/>

                           <!-- Producto (Autocomplete) -->
                           <p:outputLabel for="autoProducto" value="Producto:"/>
                           <p:autoComplete id="autoProducto"
                                           value="#{ventaFrm.ventaDetalleFrm.registro.idProducto}"
                                           completeMethod="#{ventaFrm.ventaDetalleFrm.buscarProductosPorNombre}"
                                           var="producto"
                                           itemLabel="#{producto.nombreProducto} #{producto.referenciaExterna}"
                                           itemValue="#{producto}"
                                           forceSelection="true"
                                           dropdown="true"
                                           required="true"
                                           requiredMessage="Seleccione un producto"
                                           size="50">
                              <f:converter converterId="productoConverter" />
                              <p:ajax event="itemSelect"
                                      listener="#{ventaFrm.ventaDetalleFrm.cargarPrecioPorProducto}"
                                      update="numPrecio"/>
                           </p:autoComplete>

                           <!-- Cantidad (Manual) -->
                           <p:outputLabel for="numCantidad" value="Cantidad:"/>
                           <p:inputNumber id="numCantidad"
                                          value="#{ventaFrm.ventaDetalleFrm.registro.cantidad}"
                                          decimalPlaces="2"
                                          minValue="0.01"
                                          maxValue="999999.99"
                                          required="true"
                                          requiredMessage="Ingrese la cantidad"
                                          style="width: 120px;"/>

                           <!-- Precio Unitario (Manual) -->
                           <p:outputLabel for="numPrecio" value="Precio Unitario:"/>
                           <p:inputNumber id="numPrecio"
                                          value="#{ventaFrm.ventaDetalleFrm.registro.precio}"
                                          decimalPlaces="2"
                                          minValue="0"
                                          maxValue="999999.99"
                                          required="true"
                                          requiredMessage="Ingrese el precio unitario"
                                          style="width: 120px;"/>

                           <!-- Estado (Dropdown) -->
                           <p:outputLabel for="selEstadoDetalle" value="Estado:"/>
                           <p:selectOneMenu id="selEstadoDetalle"
                                            value="#{ventaFrm.ventaDetalleFrm.registro.estado}"
                                            required="true" requiredMessage="Seleccione un estado">
                              <f:selectItems value="#{ventaFrm.ventaDetalleFrm.estadosDetalle}"
                                             var="estado"
                                             itemLabel="#{estado}"
                                             itemValue="#{estado}"/>
                           </p:selectOneMenu>

                           <!-- Observaciones -->
                           <p:outputLabel for="txtObsDetalle" value="Observaciones:"/>
                           <p:inputTextarea id="txtObsDetalle"
                                            value="#{ventaFrm.ventaDetalleFrm.registro.observaciones}"
                                            rows="3" cols="50"/>

                        </h:panelGrid>

                        <!-- Botones de acción para Detalle -->
                        <h:panelGrid columns="4" style="margin-top: 20px; text-align: center;">
                           <p:commandButton value="#{crud['frm.botones.guardar']}"
                                            actionListener="#{ventaFrm.ventaDetalleFrm.btnGuardarHandler}"
                                            rendered="#{ventaFrm.ventaDetalleFrm.estado=='CREAR'}"
                                            update=":tabVenta:pnlVentaDetalleTabla :tabVenta:pnlVentaDetalleFormulario :pnlVentaTabla"
                                            process="@form"/>

                           <p:commandButton value="#{crud['frm.botones.modificar']}"
                                            actionListener="#{ventaFrm.ventaDetalleFrm.btnModificarHandler}"
                                            rendered="#{ventaFrm.ventaDetalleFrm.estado=='MODIFICAR'}"
                                            update=":tabVenta:pnlVentaDetalleTabla :tabVenta:pnlVentaDetalleFormulario :pnlVentaTabla"
                                            process="@form"/>

                           <p:commandButton value="#{crud['frm.botones.eliminar']}"
                                            actionListener="#{ventaFrm.ventaDetalleFrm.btnEliminarHandler}"
                                            rendered="#{ventaFrm.ventaDetalleFrm.estado=='MODIFICAR'}"
                                            update=":tabVenta:pnlVentaDetalleTabla :tabVenta:pnlVentaDetalleFormulario :pnlVentaTabla"
                                            process="@form"/>

                        </h:panelGrid>

                     </p:panel>
                  </h:form>
               </h:panelGroup>

            </p:tab>

         </p:tabView>
      </h:panelGroup>
   </ui:define>

</ui:composition>